(()=>{function S(e,t){return(e&255<<t*8)>>t*8&255}function c(e){return e[3]&255|(e[2]&255)<<8|(e[1]&255)<<16|(e[0]&255)<<24}function B(e){let t=S(e,0);return`${S(e,3)}.${S(e,2)}.${S(e,1)}${t?`-${t}`:""}`}var Me=c([3,0,0,0]),Je=c([3,0,1,0]),je=c([3,0,2,0]),ze=c([3,1,0,0]),Ke=c([3,1,1,0]),Ze=c([3,1,2,0]),Ye=c([3,1,3,0]),Qe=c([3,1,4,0]),qe=c([3,2,0,0]),Xe=c([3,3,0,0]),et=c([3,4,0,0]),tt=c([3,4,1,0]),rt=c([3,4,2,0]),ot=c([3,4,3,0]),nt=c([3,4,4,0]),it=c([3,4,5,0]),st=c([3,4,6,0]),ne=c([3,4,7,0]),at=c([3,5,0,0]),W=ne;var g={EMERGENCY:800,ALERT:700,CRITICAL:600,ERROR:500,WARNING:400,NOTICE:300,METRIC:250,EVENT:225,INFO:200,DEBUG:100,DEFAULT:0};function U(e){switch(e){case g.EMERGENCY:return"EMERGENCY";case g.ALERT:return"ALERT";case g.CRITICAL:return"CRITICAL";case g.ERROR:return"ERROR";case g.WARNING:return"WARNING";case g.NOTICE:return"NOTICE";case g.INFO:return"INFO";case g.METRIC:return"METRIC";case g.EVENT:return"EVENT";case g.DEBUG:return"DEBUG";case g.DEFAULT:default:return"DEFAULT"}}function $(e){let t=e;if(t.severityCode=g[e.severity],t.timestamp=Date.now(),t.logId=ie(),t.ovvVersion=B(W),typeof Deno<"u")try{t.t_denoVersion=Deno.version.deno,t.t_v8Version=Deno.version.v8,t.t_tsVersion=Deno.version.typescript,t.t_hostname=Deno.hostname(),t.t_pid=Deno.pid,t.t_osBuild=Deno.build,t.t_mainUrl=Deno.mainModule,t.t_execPath=Deno.execPath()}catch{}for(let r of Object.keys(t))typeof t[r]>"u"&&delete t[r];return t}function ie(e=20){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let o=0;o<e;o++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}var w=class{severity;constructor(t="DEFAULT"){this.severity=typeof t=="number"?U(t):t}appendEntry(t){let r=`[${new Date(t.timestamp).toISOString()}] `;switch(typeof t.message=="string"&&(r+=t.message+": "),r+=JSON.stringify(t,null,2),t.severity){case"EMERGENCY":case"ALERT":case"CRITICAL":case"ERROR":throw console.error(r),new Error(r);case"WARNING":case"NOTICE":console.warn(r);break;case"INFO":case"DEFAULT":console.log(r);break;case"DEBUG":case"METRIC":case"EVENT":console.debug(r);break}}};var se=[new w],V=se,ae=g.DEFAULT;function M(e,t=V){if(t||(t=V),g[e.severity]>=ae){let r=$(e);for(let o of t)o.appendEntry(r)}}function C(e,t){if(!e){t=t?`Failed Assertion: "${t}"`:"Failed Assertion";debugger;let r=new Error(t);throw M({severity:"ERROR",error:"FailedAssertion",message:t,trace:r.stack}),r}}var p=globalThis.Deno?.build.os==="windows"||globalThis.navigator?.platform?.startsWith("Win")||globalThis.process?.platform?.startsWith("win")||!1;function m(e){if(typeof e!="string")throw new TypeError(`Path must be a string, received "${JSON.stringify(e)}"`)}function _(e,t){if(t.length>=e.length)return e;let r=e.length-t.length;for(let o=t.length-1;o>=0;--o)if(e.charCodeAt(r+o)!==t.charCodeAt(o))return e;return e.slice(0,-t.length)}function P(e,t,r=0){let o=!1,n=e.length;for(let s=e.length-1;s>=r;--s)if(t(e.charCodeAt(s))){if(o){r=s+1;break}}else o||(o=!0,n=s+1);return e.slice(r,n)}function O(e,t){if(m(e),e.length===0)return e;if(typeof t!="string")throw new TypeError(`Suffix must be a string, received "${JSON.stringify(t)}"`)}function E(e,t){if(e.length<=1)return e;let r=e.length;for(let o=e.length-1;o>0&&t(e.charCodeAt(o));o--)r=o;return e.slice(0,r)}function d(e){return e===47}function J(e,t=""){O(e,t);let r=P(e,d),o=E(r,d);return t?_(o,t):o}function j(e){return e===47}function a(e){return e===47||e===92}function A(e){return e>=97&&e<=122||e>=65&&e<=90}function z(e,t=""){O(e,t);let r=0;if(e.length>=2){let s=e.charCodeAt(0);A(s)&&e.charCodeAt(1)===58&&(r=2)}let o=P(e,a,r),n=E(o,a);return t?_(n,t):n}function K(e,t=""){return p?z(e,t):J(e,t)}function L(e){if(m(e),e.length===0)return"."}function Z(e){L(e);let t=-1,r=!1;for(let o=e.length-1;o>=1;--o)if(d(e.charCodeAt(o))){if(r){t=o;break}}else r=!0;return t===-1?d(e.charCodeAt(0))?"/":".":E(e.slice(0,t),d)}function Y(e){L(e);let t=e.length,r=-1,o=-1,n=!0,s=0,l=e.charCodeAt(0);if(t>1)if(a(l)){if(r=s=1,a(e.charCodeAt(1))){let i=2,f=i;for(;i<t&&!a(e.charCodeAt(i));++i);if(i<t&&i!==f){for(f=i;i<t&&a(e.charCodeAt(i));++i);if(i<t&&i!==f){for(f=i;i<t&&!a(e.charCodeAt(i));++i);if(i===t)return e;i!==f&&(r=s=i+1)}}}}else A(l)&&e.charCodeAt(1)===58&&(r=s=2,t>2&&a(e.charCodeAt(2))&&(r=s=3));else if(a(l))return e;for(let i=t-1;i>=s;--i)if(a(e.charCodeAt(i))){if(!n){o=i;break}}else n=!1;if(o===-1){if(r===-1)return".";o=r}return E(e.slice(0,o),j)}function T(e){return p?Y(e):Z(e)}function N(e){if(m(e),e.length===0)return"."}function y(e,t,r,o){let n="",s=0,l=-1,i=0,f;for(let u=0;u<=e.length;++u){if(u<e.length)f=e.charCodeAt(u);else{if(o(f))break;f=47}if(o(f)){if(!(l===u-1||i===1))if(l!==u-1&&i===2){if(n.length<2||s!==2||n.charCodeAt(n.length-1)!==46||n.charCodeAt(n.length-2)!==46){if(n.length>2){let H=n.lastIndexOf(r);H===-1?(n="",s=0):(n=n.slice(0,H),s=n.length-1-n.lastIndexOf(r)),l=u,i=0;continue}else if(n.length===2||n.length===1){n="",s=0,l=u,i=0;continue}}t&&(n.length>0?n+=`${r}..`:n="..",s=2)}else n.length>0?n+=r+e.slice(l+1,u):n=e.slice(l+1,u),s=u-l-1;l=u,i=0}else f===46&&i!==-1?++i:i=-1}return n}function F(e){N(e);let t=d(e.charCodeAt(0)),r=d(e.charCodeAt(e.length-1));return e=y(e,!t,"/",d),e.length===0&&!t&&(e="."),e.length>0&&r&&(e+="/"),t?`/${e}`:e}function k(e){N(e);let t=e.length,r=0,o,n=!1,s=e.charCodeAt(0);if(t>1)if(a(s))if(n=!0,a(e.charCodeAt(1))){let i=2,f=i;for(;i<t&&!a(e.charCodeAt(i));++i);if(i<t&&i!==f){let u=e.slice(f,i);for(f=i;i<t&&a(e.charCodeAt(i));++i);if(i<t&&i!==f){for(f=i;i<t&&!a(e.charCodeAt(i));++i);if(i===t)return`\\\\${u}\\${e.slice(f)}\\`;i!==f&&(o=`\\\\${u}\\${e.slice(f,i)}`,r=i)}}}else r=1;else A(s)&&e.charCodeAt(1)===58&&(o=e.slice(0,2),r=2,t>2&&a(e.charCodeAt(2))&&(n=!0,r=3));else if(a(s))return"\\";let l;return r<t?l=y(e.slice(r),!n,"\\",a):l="",l.length===0&&!n&&(l="."),l.length>0&&a(e.charCodeAt(t-1))&&(l+="\\"),o===void 0?n?l.length>0?`\\${l}`:"\\":l:n?l.length>0?`${o}\\${l}`:`${o}\\`:o+l}function Q(e){return p?k(e):F(e)}var ee={async open(e,t){return await Deno.mkdir(T(e),{recursive:!0}),Deno.open(e,{read:!0,write:t,create:t})},seek(e,t,r){let o;switch(r){case"start":o=Deno.SeekMode.Start;break;case"current":o=Deno.SeekMode.Current;break;case"end":o=Deno.SeekMode.End;break}return e.seek(t,o)},read(e,t){return e.read(t)},truncate(e,t){return e.truncate(t)},async write(e,t){let r=0;for(;r<t.byteLength;){let o=t.subarray(r);r+=await e.write(o)}},close(e){return e.close(),Promise.resolve()},flush(e){return e.sync()}};async function we(e){let t=await navigator.storage.getDirectory();e=Q(e);let r=e.split("/"),o=t;for(let n of r)n.length!==0&&(o=await o.getDirectoryHandle(n,{create:!0}));return o}var te={async open(e,t){let o=await(await we(T(e))).getFileHandle(K(e),{create:t});return{handle:o,file:await o.createSyncAccessHandle(),pos:0}},seek(e,t,r){switch(r){case"current":t+=e.pos;break;case"start":break;case"end":t=e.file.getSize()-t;break}return e.pos=t,Promise.resolve(t)},read(e,t){if(e.pos>=e.file.getSize())return Promise.resolve(null);let r=e.file.read(t,{at:e.pos});return e.pos+=r,Promise.resolve(r)},truncate(e,t){return t=Math.max(0,t),e.file.truncate(t),e.pos=Math.min(t,e.pos),Promise.resolve()},write(e,t){let r=0;for(;r<t.byteLength;){let o=t.subarray(r),n=e.file.write(o,{at:e.pos});r+=n,e.pos+=n}return Promise.resolve()},close(e){return e.file.close(),Promise.resolve()},flush(e){return e.file.flush(),Promise.resolve()}};function v(){return self.Deno===void 0?te:ee}var _e=1024*1024,I=1024,re=10,Pe=new TextDecoder;async function Oe(e,t=!1){let r=v();return{path:e,write:t===!0,impl:r,handle:await r.open(e,t),pendingWrites:[],knownIds:new Set}}function Le(e){return e.impl.close(e.handle)}async function Te(e){let t=await e.impl.seek(e.handle,0,"end");return await e.impl.seek(e.handle,0,"start"),{file:e,totalFileBytes:t,fileOffset:0,readBuf:new Uint8Array(_e),readBufLen:0,readBufStart:0,readBufEnd:0,lastGoodFileOffset:0,objectBuf:new Uint8Array(I),objectBufOffset:0}}async function G(e){let t=[];for(;t.length<=50;){for(;e.readBufLen<=0;){let r=await e.file.impl.read(e.file.handle,e.readBuf);if(r===null)return e.objectBufOffset>0&&e.file.write&&(await e.file.impl.seek(e.file.handle,0,"end"),await e.file.impl.truncate(e.file.handle,e.lastGoodFileOffset)),e.file.didScan=!0,[t,!0];e.readBufLen=r}for(;e.readBufStart<e.readBufLen;){for(e.readBufEnd=e.readBufStart;e.readBufEnd<e.readBufLen&&e.readBuf[e.readBufEnd]!==re;)++e.readBufEnd;let r=e.readBufEnd-e.readBufStart;if(r>0&&(e.fileOffset+=r,e.objectBuf=Fe(e.readBuf,e.readBufStart,r,e.objectBuf,e.objectBufOffset),e.objectBufOffset+=r),e.readBufStart=e.readBufEnd+1,e.readBuf[e.readBufEnd]===re&&e.objectBufOffset>0)try{let o=Pe.decode(e.objectBuf.subarray(0,e.objectBufOffset));t.push(JSON.parse(o)),e.lastGoodFileOffset+=e.objectBufOffset+1,e.objectBufOffset=0}catch{e.file.write&&(await e.file.impl.seek(e.file.handle,0,"end"),await e.file.impl.truncate(e.file.handle,e.lastGoodFileOffset)),e.file.didScan=!0;for(let n of t)typeof n.id=="string"&&e.file.knownIds.add(n.id);return[t,!0]}}e.readBufStart>=e.readBufLen&&(e.readBufLen=0,e.readBufStart=0,e.readBufEnd=0)}for(let r of t)typeof r.id=="string"&&e.file.knownIds.add(r.id);return[t,!1]}function Ne(e){return e.impl.flush(e.handle)}function Fe(e,t,r,o,n){if(n+r>o.byteLength){let s=new Uint8Array(Math.ceil((n+r)*2/I)*I);s.set(o),o=s}return o.set(e.subarray(t,t+r),n),o}async function ke(e,t){C(e.write,"Attempting to write to a readonly log"),C(e.didScan===!0,"Attempting to append to log before initial scan completed");let r=[];for(let s of t)typeof s.id=="string"&&!e.knownIds.has(s.id)&&(e.knownIds.add(s.id),r.push(s));let o=`
`+r.map(s=>JSON.stringify(s)).join(`

`)+`
`,n=new TextEncoder().encode(o);await e.impl.seek(e.handle,0,"end"),await e.impl.write(e.handle,n)}var b=new Map,ve=0,oe=new Map,De=0;async function Ge(e){let t=v(),r=await t.open(e,!1),o=await t.seek(r,0,"end");await t.seek(r,0,"start");let n=new Uint8Array(o);return await t.read(r,n),await t.close(r),n}async function Ie(e){try{return new TextDecoder().decode(await Ge(e))}catch{return}}async function He(e,t){let r=v(),o=await r.open(e,!0);await r.write(o,t),await r.truncate(o,t.length),await r.close(o)}async function Be(e,t){try{let r=new TextEncoder;return await He(e,r.encode(t)),!0}catch{return!1}}function We(){console.log("WORKER STARTED"),onmessage=async e=>{switch(e.data.type){case"open":{let t=++ve,r=await Oe(e.data.path,e.data.write);b.set(t,r);let o={type:"open",id:e.data.id,file:t};postMessage(JSON.stringify(o));break}case"close":{let t=b.get(e.data.file);t&&(b.delete(e.data.file),await Le(t));let r={type:"close",id:e.data.id,file:e.data.file};postMessage(JSON.stringify(r));break}case"cursor":{let t=b.get(e.data.file);C(t!==void 0,"File not found");let r=await Te(t),o=++De,n=G(r);oe.set(o,{cursor:r,nextPromise:n});let s={type:"cursor",id:e.data.id,cursor:o};postMessage(JSON.stringify(s));break}case"scan":{let t=oe.get(e.data.cursor);C(t!==void 0,"Cursor not found"),t.nextPromise||(t.nextPromise=G(t.cursor));let[r,o]=await t.nextPromise;t.nextPromise=G(t.cursor);let n={type:"scan",id:e.data.id,cursor:e.data.cursor,values:r,done:o};postMessage(JSON.stringify(n));break}case"flush":{let t=b.get(e.data.file);C(t!==void 0,"File not found"),await Ne(t);let r={type:"flush",id:e.data.id,file:e.data.file};postMessage(JSON.stringify(r));break}case"append":{let t=b.get(e.data.file);C(t!==void 0,"File not found"),await ke(t,e.data.values);let r={type:"append",id:e.data.id};postMessage(JSON.stringify(r));break}case"readTextFile":{let t={type:"readTextFile",id:e.data.id,text:await Ie(e.data.path)};postMessage(JSON.stringify(t));break}case"writeTextFile":{let t={type:"writeTextFile",id:e.data.id,success:await Be(e.data.path,e.data.text)};postMessage(JSON.stringify(t));break}}}}We();})();
