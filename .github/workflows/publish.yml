name: Publish

on:
  push:
    tags: ["v*"]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # GitHub Release creation
      id-token: write       # OIDC for JSR + npm Trusted Publisher

    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install npm 11.5.1 (minimum for OIDC Trusted Publishing)
        run: npm install -g npm@11.5.1

      - name: Install npm dependencies
        run: rm -rf node_modules && npm install

      - name: Build npm artifact
        run: npm run build:npm

      # Extract version from deno.json; rewrite package.json version + exports for npm publish.
      # In the repo, exports point to .ts source (for local dev/tests). Here we switch to dist/.
      # --node-modules-dir=none prevents Deno from populating node_modules/ during the eval,
      # which would otherwise seed vitest into the tree and break npm 11's peer-dep resolution.
      # This runs AFTER npm install + build so the lockfile matches during install.
      - name: Sync version and exports from deno.json â†’ package.json
        run: |
          VERSION=$(deno eval --node-modules-dir=none "import cfg from './deno.json' with {type:'json'}; console.log(cfg.version)")
          deno eval --node-modules-dir=none "
            import pkg from './package.json' with {type:'json'};
            pkg.version = '$VERSION';
            pkg.exports = {
              '.':              { import: './dist/mod.mjs',          types: './dist/mod.d.ts' },
              './react':        { import: './dist/react/hooks.mjs',  types: './dist/react/hooks.d.ts' },
              './server':       { import: './dist/server.mjs',       types: './dist/server.d.ts' },
              './server/build': { import: './dist/server-build.mjs', types: './dist/server-build.d.ts' },
              './init':         { import: './dist/cli/init.mjs',     types: './dist/cli/init.d.ts' },
              './link':         { import: './dist/cli/link.mjs',     types: './dist/cli/link.d.ts' },
            };
            await Deno.writeTextFile('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Publish to JSR
        run: npx jsr publish --allow-dirty

      - name: Publish to npm
        run: |
          VERSION=$(deno eval --node-modules-dir=none "import cfg from './deno.json' with {type:'json'}; console.log(cfg.version)")
          if [[ "$VERSION" == *"-"* ]]; then
            npm publish --access public --tag next
          else
            npm publish --access public
          fi

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          gh release create "$GITHUB_REF_NAME" \
            --title "v$VERSION" \
            --notes-file CHANGELOG.md \
            --verify-tag
